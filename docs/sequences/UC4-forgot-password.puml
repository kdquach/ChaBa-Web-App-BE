@startuml UC4 Forgot Password
!theme plain
skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center
skinparam BoxPadding 10

title UC4 - Forgot Password (OTP-based)

actor "User" as User
boundary "Forgot Password\nPage" as FE
participant ":API Gateway\n(Express Router)" as Router
participant ":validateMiddleware" as ValidateMW
participant ":authController" as AuthCtrl
participant ":authService" as AuthSvc
participant ":userService" as UserSvc
participant ":otpService" as OTPSvc
participant ":emailService" as EmailSvc
database "MongoDB\n(Users Collection)" as UserDB
database "MongoDB\n(OTP Collection)" as OTPDB
participant ":SMTP Server" as SMTP

== Step 1: Request Password Reset ==

User -> FE: Navigate to /forgot-password
activate FE

FE -> FE: Display email input form

FE --> User: "Enter your email address"

User -> FE: Enter email and\nclick "Send OTP"

FE -> FE: Validate email format\n(client-side)

FE -> Router: POST /v1/auth/forgot-password/send-otp\nBody: {email}
activate Router

== Validation ==

Router -> ValidateMW: validate(authValidation.forgotPasswordStep1)
activate ValidateMW

ValidateMW -> ValidateMW: Validate body:\n- email (required, email format)

alt Invalid Email Format
    ValidateMW --> Router: 400 Bad Request
    Router --> FE: Validation error
    FE --> User: "Invalid email format"
else Valid
    ValidateMW --> Router: Next()
    deactivate ValidateMW
end

== Process Forgot Password ==

Router -> AuthCtrl: forgotPasswordStep1(req, res)
activate AuthCtrl

AuthCtrl -> AuthSvc: forgotPasswordStep1(req.body.email)
activate AuthSvc

== Verify User Exists ==

AuthSvc -> UserSvc: getUserByEmail(email)
activate UserSvc

UserSvc -> UserDB: User.findOne({ email })
activate UserDB
UserDB --> UserSvc: Return user or null
deactivate UserDB

alt User Not Found
    UserSvc --> AuthSvc: Return null
    deactivate UserSvc
    
    AuthSvc --> AuthCtrl: throw ApiError(404,\n"No user found with this email")
    AuthCtrl --> Router: 404 Not Found
    Router --> FE: Error response
    FE --> User: "No account found\nwith this email"
    
else User Found (with Local Provider)
    UserSvc --> AuthSvc: Return user
    deactivate UserSvc
    
    alt User Registered with Social Login
        AuthSvc -> AuthSvc: Check user.provider
        
        alt Provider is Google/Facebook
            AuthSvc --> AuthCtrl: throw ApiError(400,\n"This account uses social login")
            AuthCtrl --> Router: 400 Bad Request
            Router --> FE: Error response
            FE --> User: "Please login with Google/Facebook"
        end
    end
end

== Generate and Send OTP ==

AuthSvc -> OTPSvc: createAndSendOTP(email, "FORGOT_PASSWORD")
activate OTPSvc

OTPSvc -> OTPDB: OTP.deleteMany({\n  email,\n  type: "FORGOT_PASSWORD",\n  verified: false\n})
activate OTPDB
note right of OTPDB
  Clean up old unverified
  password reset OTPs
end note
OTPDB --> OTPSvc: Old OTPs deleted
deactivate OTPDB

OTPSvc -> OTPSvc: Generate 6-digit OTP:\ncrypto.randomInt(100000, 999999)

OTPSvc -> OTPSvc: Set expiry:\nnow + 10 minutes

OTPSvc -> OTPDB: OTP.create({\n  email,\n  otp,\n  type: "FORGOT_PASSWORD",\n  expiresAt,\n  attempts: 0,\n  verified: false\n})
activate OTPDB
OTPDB --> OTPSvc: OTP saved
deactivate OTPDB

OTPSvc -> EmailSvc: sendResetPasswordOTP(email, otp)
activate EmailSvc

EmailSvc -> SMTP: Send email via nodemailer
activate SMTP
SMTP --> EmailSvc: Email sent
deactivate SMTP

EmailSvc --> OTPSvc: Email delivered
deactivate EmailSvc

OTPSvc --> AuthSvc: OTP created and sent
deactivate OTPSvc

AuthSvc --> AuthCtrl: Success
deactivate AuthSvc

AuthCtrl --> Router: 200 OK\n{message: "OTP đặt lại mật khẩu\nđã được gửi đến email"}
deactivate AuthCtrl

Router --> FE: Success response
deactivate Router

FE -> FE: Navigate to OTP verification page

FE -> FE: Show OTP input field\nStart 10-minute countdown

FE --> User: "Check your email for OTP"
deactivate FE

== Step 2: Verify OTP ==

User -> User: Open email\nCopy OTP code

User -> FE: Enter OTP code\nClick "Verify"
activate FE

FE -> Router: POST /v1/auth/forgot-password/verify-otp\nBody: {email, otp}
activate Router

Router -> ValidateMW: validate(authValidation.forgotPasswordStep2)
activate ValidateMW

ValidateMW -> ValidateMW: Validate:\n- email (required, email format)\n- otp (required, 6 digits)

ValidateMW --> Router: Next()
deactivate ValidateMW

Router -> AuthCtrl: forgotPasswordStep2(req, res)
activate AuthCtrl

AuthCtrl -> AuthSvc: forgotPasswordStep2(email, otp)
activate AuthSvc

== Verify OTP ==

AuthSvc -> OTPSvc: verifyOTP(email, otp, "FORGOT_PASSWORD")
activate OTPSvc

OTPSvc -> OTPDB: OTP.findOne({\n  email,\n  type: "FORGOT_PASSWORD",\n  verified: false,\n  expiresAt: {$gt: now}\n})
activate OTPDB
OTPDB --> OTPSvc: Return OTP document
deactivate OTPDB

alt OTP Not Found or Expired
    OTPSvc --> AuthSvc: throw ApiError(400,\n"OTP expired or invalid")
    AuthSvc --> AuthCtrl: Error
    AuthCtrl --> Router: 400 Bad Request
    Router --> FE: Error response
    FE --> User: "OTP expired\nRequest a new one"
end

OTPSvc -> OTPSvc: Check attempts < 5

alt Too Many Failed Attempts
    OTPSvc -> OTPDB: OTP.deleteOne({_id})
    activate OTPDB
    deactivate OTPDB
    
    OTPSvc --> AuthSvc: throw ApiError(429,\n"Too many attempts")
    AuthSvc --> AuthCtrl: Error
    AuthCtrl --> Router: 429 Too Many Requests
    Router --> FE: Error response
    FE --> User: "Too many attempts\nRequest new OTP"
end

OTPSvc -> OTPDB: otpDoc.attempts += 1\notpDoc.save()
activate OTPDB
deactivate OTPDB

OTPSvc -> OTPSvc: Compare entered OTP\nwith stored OTP

alt OTP Mismatch
    OTPSvc --> AuthSvc: throw ApiError(400,\n"Incorrect OTP")
    AuthSvc --> AuthCtrl: Error
    AuthCtrl --> Router: 400 Bad Request
    Router --> FE: Error response
    FE --> User: "Wrong OTP\nTry again"
end

OTPSvc -> OTPDB: otpDoc.verified = true\notpDoc.save()
activate OTPDB
note right of OTPDB
  Mark OTP as verified
  Will be cleaned up after
  password reset
end note
deactivate OTPDB

OTPSvc --> AuthSvc: OTP verified
deactivate OTPSvc

AuthSvc --> AuthCtrl: Success
deactivate AuthSvc

AuthCtrl --> Router: 200 OK\n{message: "OTP verified.\nYou can reset password."}
deactivate AuthCtrl

Router --> FE: Success response
deactivate Router

FE -> FE: Navigate to\nreset password page

FE -> FE: Display new password form\nKeep email in state

FE --> User: "Enter new password"
deactivate FE

@enduml
