@startuml UC2.4 Search Product
!theme plain
skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center
skinparam BoxPadding 10

title UC2.4 - Search Product

actor "Guest/User" as User
boundary "Product Catalog\nPage" as FE
participant ":API Gateway\n(Express Router)" as Router
participant ":authMiddleware" as AuthMW
participant ":validateMiddleware" as ValidateMW
participant ":productController" as Controller
participant ":productService" as Service
database "MongoDB\n(Product Collection)" as DB

== User Enters Search Query ==

User -> FE: Type in search box:\n"trÃ  sá»¯a"
activate FE

FE -> FE: Debounce input\n(wait 300ms after typing stops)

note right of FE
  Search UI:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ðŸ” [trÃ  sá»¯a_______] [X] â”‚
  â”‚                          â”‚
  â”‚ Searching...             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  
  Debouncing prevents
  API spam during typing
end note

FE --> User: Show loading indicator

== Send Search Request ==

FE -> Router: GET /v1/products?\nname=trÃ  sá»¯a&\npage=1&limit=12
activate Router

note right of FE
  Search query parameters:
  - name: "trÃ  sá»¯a" (search term)
  - page: 1 (reset to first page)
  - limit: 12 (results per page)
  - Other filters can be combined
end note

== Authentication (Optional) ==

Router -> AuthMW: auth("getProducts")
activate AuthMW

AuthMW -> AuthMW: Verify token\n(optional for guests)

AuthMW --> Router: Next()
deactivate AuthMW

== Validation ==

Router -> ValidateMW: validate(productValidation.getProducts)
activate ValidateMW

ValidateMW -> ValidateMW: Validate query params:\n- name (string, optional)\n- page, limit (integers)

ValidateMW --> Router: Next()
deactivate ValidateMW

== Build Search Filter ==

Router -> Controller: getProducts(req, res)
activate Controller

Controller -> Controller: Build filter with\nname search pattern

note right of Controller
  If req.query.name exists:
  filter.name = {
    $regex: "trÃ  sá»¯a",
    $options: "i"  // case-insensitive
  }
  
  MongoDB will use index on name
  field for better performance
end note

Controller -> Controller: filter = {\n  name: {\n    $regex: "trÃ  sá»¯a",\n    $options: "i"\n  }\n}

Controller -> Controller: options = {\n  page: 1,\n  limit: 12,\n  sortBy: "createdAt:desc",\n  populate: "categoryId"\n}

Controller -> Service: queryProducts(filter, options)
activate Service

== Execute Search Query ==

Service -> DB: Product.paginate(filter, options)
activate DB

DB -> DB: Build regex search query:\ndb.products.find({\n  name: /trÃ  sá»¯a/i\n})

note right of DB
  MongoDB regex search:
  - Case-insensitive match
  - Partial match (contains)
  - Uses index if available
  
  Matches:
  âœ“ "TrÃ  Sá»¯a TrÃ¢n ChÃ¢u"
  âœ“ "TrÃ  sá»¯a Ä‘Æ°á»ng Ä‘en"
  âœ“ "TRÃ€ Sá»®A MATCHA"
  âœ— "CÃ  phÃª sá»¯a Ä‘Ã¡"
end note

DB -> DB: Apply pagination and populate

DB --> Service: Return matching products
deactivate DB

note right of Service
  Search results:
  {
    results: [
      {
        _id, 
        name: "TrÃ  Sá»¯a TrÃ¢n ChÃ¢u ÄÆ°á»ng Äen",
        price: 45000,
        image: "...",
        categoryId: {name: "TrÃ  Sá»¯a"},
        ...
      },
      {
        name: "TrÃ  Sá»¯a Matcha",
        price: 48000,
        ...
      },
      ...
    ],
    page: 1,
    limit: 12,
    totalPages: 2,
    totalResults: 15  // found 15 products
  }
end note

Service --> Controller: Return search results
deactivate Service

Controller --> Router: 200 OK\n{search results}
deactivate Controller

Router --> FE: Success response
deactivate Router

== Display Search Results ==

FE -> FE: Hide loading indicator

alt No Results Found
    FE -> FE: Display empty state:\n"No products found for 'trÃ  sá»¯a'"
    FE -> FE: Show suggestions:\n- Check spelling\n- Try different keywords\n- Browse categories
    
    note right of FE
      Empty State UI:
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚   ðŸ”                   â”‚
      â”‚   No results found     â”‚
      â”‚   for "trÃ  sá»¯a"        â”‚
      â”‚                        â”‚
      â”‚   Suggestions:         â”‚
      â”‚   â€¢ Try "milk tea"     â”‚
      â”‚   â€¢ Browse categories  â”‚
      â”‚   â€¢ View all products  â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    end note
    
    FE --> User: Show empty state
    
else Results Found
    FE -> FE: Display search results header:\n"Found 15 products for 'trÃ  sá»¯a'"
    
    FE -> FE: Highlight search term\nin product names (optional)
    
    loop For each product in results
        FE -> FE: Render product card\nwith matched text highlighted
    end
    
    FE -> FE: Setup pagination\n(if results > limit)
    
    note right of FE
      Search Results:
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Found 15 results         â”‚
      â”‚                          â”‚
      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
      â”‚ â”‚   Image     â”‚          â”‚
      â”‚ â”‚ TrÃ  Sá»¯a...  â”‚          â”‚
      â”‚ â”‚ 45,000â‚«     â”‚          â”‚
      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
      â”‚                          â”‚
      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
      â”‚ â”‚   Image     â”‚          â”‚
      â”‚ â”‚ TrÃ  Sá»¯a...  â”‚          â”‚
      â”‚ â”‚ 48,000â‚«     â”‚          â”‚
      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
      â”‚                          â”‚
      â”‚ [1] [2] â†’                â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    end note
    
    FE --> User: Display search results\n"15 products found"
end

deactivate FE

== User Refines Search ==

User -> FE: Add filter:\nCategory = "TrÃ  Sá»¯a"\nwhile keeping search term
activate FE

FE -> FE: Combine search + filter:\nname = "trÃ  sá»¯a"\ncategory = "507f..."

FE -> Router: GET /v1/products?\nname=trÃ  sá»¯a&\ncategory=507f...&\npage=1&limit=12
activate Router

Router -> AuthMW: auth("getProducts")
activate AuthMW
AuthMW --> Router: Next()
deactivate AuthMW

Router -> Controller: getProducts(req, res)
activate Controller

Controller -> Controller: Build combined filter:\n{\n  name: {$regex: "trÃ  sá»¯a", $options: "i"},\n  categoryId: ObjectId("507f...")\n}

note right of Controller
  Combined search + filter
  narrows down results
end note

Controller -> Service: queryProducts(filter, options)
activate Service
Service -> DB: Product.paginate(filter, options)
activate DB

DB -> DB: Execute combined query:\nFind products matching BOTH\nname pattern AND category

DB --> Service: Return refined results
deactivate DB
Service --> Controller: Return products
deactivate Service
Controller --> Router: 200 OK\n{refined results}
deactivate Controller
Router --> FE: Success response
deactivate Router

FE -> FE: Update results:\n"Found 12 products in TrÃ  Sá»¯a\nmatching 'trÃ  sá»¯a'"

FE --> User: Display refined results
deactivate FE

== User Clears Search ==

User -> FE: Click [X] to clear search
activate FE

FE -> FE: Clear search input\nReset filter to default

FE -> Router: GET /v1/products?\npage=1&limit=12
activate Router

Router -> AuthMW: auth("getProducts")
activate AuthMW
AuthMW --> Router: Next()
deactivate AuthMW

Router -> Controller: getProducts(req, res)
activate Controller
Controller -> Service: queryProducts({}, options)
activate Service
Service -> DB: Product.paginate({}, options)
activate DB
DB --> Service: Return all products
deactivate DB
Service --> Controller: Return products
deactivate Service
Controller --> Router: 200 OK\n{all products}
deactivate Controller
Router --> FE: Success response
deactivate Router

FE -> FE: Display all products\nClear search highlight
FE --> User: "Showing all products"
deactivate FE

@enduml
