@startuml UC5 Reset Password
!theme plain
skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center
skinparam BoxPadding 10

title UC5 - Reset Password (After OTP Verification)

actor "User" as User
boundary "Reset Password\nPage" as FE
participant ":API Gateway\n(Express Router)" as Router
participant ":validateMiddleware" as ValidateMW
participant ":authController" as AuthCtrl
participant ":authService" as AuthSvc
participant ":otpService" as OTPSvc
participant ":userService" as UserSvc
database "MongoDB\n(OTP Collection)" as OTPDB
database "MongoDB\n(Users Collection)" as UserDB

== User Enters New Password ==

note right of User
  Prerequisites:
  - User has received OTP email
  - OTP has been verified (UC4)
  - User is on reset password page
end note

User -> FE: Enter new password\nand confirmation
activate FE

FE -> FE: Validate password:\n- Min 8 characters\n- At least 1 uppercase\n- At least 1 number\n- Match confirmation

alt Passwords Don't Match
    FE --> User: "Passwords don't match"
else Weak Password
    FE --> User: "Password doesn't meet\nrequirements"
end

User -> FE: Click "Reset Password"

FE -> Router: POST /v1/auth/reset-password/with-otp\nBody: {email, password}
activate Router

note right of FE
  Request includes:
  - email (from previous step)
  - password (new password)
  
  OTP verification state is
  checked on backend
end note

== Validation ==

Router -> ValidateMW: validate(authValidation.resetPasswordWithOTP)
activate ValidateMW

ValidateMW -> ValidateMW: Validate body:\n- email (required, email format)\n- password (required, custom validation)

alt Validation Failed
    ValidateMW --> Router: 400 Bad Request\n{error: validation details}
    Router --> FE: Validation error
    FE --> User: Show validation errors
else Valid
    ValidateMW --> Router: Next()
    deactivate ValidateMW
end

== Reset Password Process ==

Router -> AuthCtrl: resetPasswordWithOTP(req, res)
activate AuthCtrl

AuthCtrl -> AuthSvc: resetPasswordWithOTP(email, password)
activate AuthSvc

== Check OTP Was Verified ==

AuthSvc -> OTPSvc: isOTPVerified(email, "FORGOT_PASSWORD")
activate OTPSvc

OTPSvc -> OTPDB: OTP.findOne({\n  email,\n  type: "FORGOT_PASSWORD",\n  verified: true\n})
activate OTPDB

OTPDB --> OTPSvc: Return verified OTP or null
deactivate OTPDB

alt OTP Not Verified
    OTPSvc --> AuthSvc: Return false
    deactivate OTPSvc
    
    AuthSvc --> AuthCtrl: throw ApiError(400,\n"Please verify OTP first")
    AuthCtrl --> Router: 400 Bad Request
    Router --> FE: Error response
    FE --> User: "OTP not verified\nPlease verify OTP first"
else OTP Verified
    OTPSvc --> AuthSvc: Return true
    deactivate OTPSvc
end

== Get User ==

AuthSvc -> UserSvc: getUserByEmail(email)
activate UserSvc

UserSvc -> UserDB: User.findOne({ email })
activate UserDB
UserDB --> UserSvc: Return user
deactivate UserDB

alt User Not Found
    UserSvc --> AuthSvc: Return null
    deactivate UserSvc
    
    AuthSvc --> AuthCtrl: throw ApiError(404,\n"User not found")
    AuthCtrl --> Router: 404 Not Found
    Router --> FE: Error response
    FE --> User: "User not found"
end

UserSvc --> AuthSvc: Return user
deactivate UserSvc

== Update Password ==

AuthSvc -> AuthSvc: user.password = newPassword

note right of AuthSvc
  Set new password on user instance
  (will be hashed by pre-save hook)
end note

AuthSvc -> UserDB: user.save()
activate UserDB

UserDB -> UserDB: Hash password with bcrypt\nUpdate updatedAt timestamp

UserDB --> AuthSvc: User saved with\nnew hashed password
deactivate UserDB

== Clean Up OTP Records ==

AuthSvc -> OTPDB: OTP.deleteMany({\n  email,\n  type: "FORGOT_PASSWORD"\n})
activate OTPDB

note right of OTPDB
  Delete all password reset OTPs
  for this email (verified or not)
  to prevent reuse
end note

OTPDB --> AuthSvc: OTPs deleted
deactivate OTPDB

AuthSvc --> AuthCtrl: Password reset successful
deactivate AuthSvc

AuthCtrl --> Router: 200 OK\n{message: "Mật khẩu đã được\nđặt lại thành công"}
deactivate AuthCtrl

Router --> FE: Success response
deactivate Router

== Success & Redirect ==

FE -> FE: Clear password fields

FE -> FE: Show success message:\n"Password reset successful!"

FE -> FE: Start redirect countdown:\n"Redirecting to login in 3..."

FE -> FE: Wait 3 seconds

FE -> FE: Redirect to /login

FE --> User: Navigate to login page\nwith success message
deactivate FE

== User Logs In with New Password ==

User -> FE: Enter email and\nnew password
activate FE

FE -> Router: POST /v1/auth/login\nBody: {email, password}
activate Router

note right of FE
  This triggers the
  normal login flow (UC24.1)
  with the new password
end note

Router -> Router: Validate and authenticate\nwith new password

Router --> FE: 200 OK\n{user, tokens}
deactivate Router

FE -> FE: Store tokens\nStore user info

FE --> User: Login successful!\nRedirect to dashboard
deactivate FE

note right of User
  Password reset complete!
  User can now login with
  the new password
end note

@enduml
